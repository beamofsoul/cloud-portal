<!DOCTYPE html>  
<html xmlns:th="http://www.thymeleaf.org">  
    <head>  
        <title>Rabbit Index</title>
        <script th:src="@{/static/jquery/js/jquery-3.2.1.min.js}"></script>
    	<script th:src="@{/static/WEBSOCKET/js/sockjs-1.1.2.min.js}"></script>
    </head>  
    <body>  
        <div th:replace="fragment/header"></div>
        <h1 style="text-align: center;">Rabbit  1.0.1</h1>
        <hr>
        
		<a href="javascript:getQRCodeUrl()">GetQRCode</a>
		<hr>
		<img id="qrcode" style="widows: 400px;height: 400px;border: 1px solid black;">
    </body>
    
    <script type="text/javascript">
    // 该段JS主要用户帮助用户在扫码成功后关注服务号，并能够实现自动登录网站
 	// 1. 用户加载登录页面，JS自动生成unicode，并且2秒钟后自动发送给websocket服务器将unicode存储在WebSocketSession中
	// 2. 用户点击微信扫码按钮，将unicode用作sceneId随机生成二维码，并在当前页面不跳转的情况下显示给当前用户
	// 3. 用户扫码后，微信服务号后台获取到unicode作为的sceneId，通知websocket服务器，让它给有session中unicode值与传给它的unicode的值一致的session发送特定消息，将自动登录命令和openId一同发送过去
	// 4. 前台页面收到特定消息(自动登陆命令和openId)，自动帮助用户跳转登录
    
    	var unicode;
    	var hostUrl = "http://192.168.31.137:80/";
		var websocket = null;
		var transports = [];
		
		var url = hostUrl + 'sockjs'; 
		websocket = new SockJS(url, undefined, {transports: transports});
		
		websocket.onopen = function() {
			console.log('websocket: connection is opened');
		};
		websocket.onclose = function() {
			console.log('websocket: connection is closed');
		};
		websocket.onheartbeat = function() {
		    console.log('websocket: connection heartbeat...');
		};
		websocket.onmessage = function(e) {
			if (e.data.indexOf("AUTOMATIC_LOGIN") != -1) {
				websocket.onclose();
				helpToLoginAutomatically(e);
			} else {
				console.log('websocket:', e.data);
			}
		};
		
		// 1. 用户加载登录页面，JS自动生成unicode，并且2秒钟后自动发送给websocket服务器将unicode存储在WebSocketSession中
		$(function() {
			unicode = Math.round(Math.random() * 1000000000);
			setTimeout("websocket.send("+unicode+")", 2000); // 向websocket服务器发送message，与websocket服务器存储的特定session进行绑定
	    }); 
		// 2. 用户点击微信扫码按钮，将unicode用作sceneId随机生成二维码，并在当前页面不跳转的情况下显示给当前用户
		function getQRCodeUrl() {
			$.get(hostUrl + "wechat/getQRCode?sceneId=" + unicode, null, function(url) {
				$("#qrcode").attr("src", url);
			});
		}
		// 4. 前台页面收到特定消息(自动登陆命令和openId)，自动帮助用户跳转登录
		function helpToLoginAutomatically(e) {
			var mixedValues = e.data.split('####');
			var openId = mixedValues[1]; // 用户的openId
			var sceneId = 911; // 登录系统默认场景值
			// 关闭二维码
			// 通过ajax访问后台认证并登录
			$.get(hostUrl + 'oauth/token?client_id=client_hm&client_secret=123456&grant_type=password&username='+openId+'&password='+sceneId, null, result => {
				console.log(result); // 成功获取access_token
				var access_token = result.access_token;
				$.get(hostUrl + "open/user/login?access_token="+access_token+"&username="+openId+"&password="+sceneId, null, result1 => {
					console.log(result1); // 成功登录并获取到登录用户信息
				});
			});
		}
	</script>
</html>  